<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{% block title %}My Personal Blog{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde@2.18.0/dist/easymde.min.js"></script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
        tex2jax: {  
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            processEscapes: true
        }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.min.js" async></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
    <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('main.index') }}">学习博客</a>
            <ul class="navbar-nav me-auto">
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.index') }}">首页Home</a></li>
                {% if current_user.is_authenticated %}
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.create_post') }}">新的发表New Post</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.categories') }}">文章类型Categories</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.dashboard') }}">总览Dashboard</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.profile') }}">个人信息Profile</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.logout') }}">退出Logout</a></li>
                {% else %}
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.login') }}">登入Login</a></li>
                <li class="nav-item"><a class="nav-link" href="{{ url_for('main.register') }}">注册Register</a></li>
                {% endif %}
            </ul>
            <form class="d-flex" action="{{ url_for('main.search') }}">
                <input class="form-control me-2" type="search" name="query" placeholder="Search" aria-label="Search">
                <button class="btn btn-outline-success" type="submit">查找Search</button>
            </form>
            <!-- Add Mute Button Here -->
            <button id="mute-btn" class="btn btn-secondary ms-2">Mute Music</button>
        </div>
    </nav>
    <!-- Add Audio Element (Hidden) -->
    <audio id="bg-music" loop src="{{ url_for('static', filename='audio/Rain in Jiang (Violin Remix).mp3') }}" ></audio>
    <div class="container mt-3">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-info">
            {{ messages[0] }}
        </div>
        {% endif %}
        {% endwith %}
        <!-- Wrap Content for AJAX -->
        <div id="main-content">
            {% block content %}{% endblock %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <!-- Add JS for Music and AJAX Persistence -->
    <script>
        // Music Control
        document.addEventListener('DOMContentLoaded', () => {
            const audio = document.getElementById('bg-music');
            const muted = localStorage.getItem('muted') === 'true';
            audio.muted = muted;
            if (!muted) {
                audio.play().catch(e => console.log('Autoplay prevented:', e));
            }
            const muteBtn = document.getElementById('mute-btn');
            muteBtn.addEventListener('click', () => {
                audio.muted = !audio.muted;
                localStorage.setItem('muted', audio.muted);
                muteBtn.textContent = audio.muted ? 'Unmute Music' : 'Mute Music';
            });
            muteBtn.textContent = muted ? 'Unmute Music' : 'Mute Music';
        });

        // AJAX for Persistent Navigation
        async function loadContent(url) {
            try {
                const response = await fetch(url);
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                document.title = doc.title;
                document.getElementById('main-content').innerHTML = doc.querySelector('#main-content').innerHTML;
                // Re-flash messages or other dynamic elements if needed
                // Re-typeset MathJax
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise();
                }
                // Re-init EasyMDE if on edit pages (optional, add if needed)
            } catch (e) {
                console.error('AJAX load failed:', e);
                window.location.href = url; // Fallback to full load
            }
        }

        document.addEventListener('click', e => {
            if (e.target.tagName === 'A' && e.target.href.startsWith(location.origin) && !e.target.dataset.noAjax) {
                e.preventDefault();
                history.pushState({ url: e.target.href }, '', e.target.href);
                loadContent(e.target.href);
            }
        });

        window.addEventListener('popstate', e => {
            if (e.state && e.state.url) {
                loadContent(e.state.url);
            }
        });
    </script>
</body>
</html>